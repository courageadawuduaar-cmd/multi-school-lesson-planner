{% extends "base.html" %}
{% block title %}Create Lesson{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Create Lesson</h2>
    <p class="text-muted">Fill all fields to create a lesson.</p>

    <form method="POST" enctype="multipart/form-data" id="lessonForm" novalidate>
        {{ form.hidden_tag() }}

        {% if form.errors %}
        <div class="alert alert-danger">
            <ul class="mb-0">
                {% for field, errors in form.errors.items() %}
                    {% for error in errors %}
                        <li><strong>{{ field }}:</strong> {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="row g-3">

            <div class="col-md-6">
                {{ form.lesson_date.label(class="form-label") }}
                {{ form.lesson_date(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.week_ending.label(class="form-label") }}
                {{ form.week_ending(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.class_name.label(class="form-label") }}
                {{ form.class_name(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.subject.label(class="form-label") }}
                {{ form.subject(class="form-control") }}
            </div>

            <!-- ✅ FIXED: lesson_title (NOT lesson_topic) -->
            <div class="col-md-6">
                {{ form.lesson_title.label(class="form-label") }}
                {{ form.lesson_title(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.strand.label(class="form-label") }}
                {{ form.strand(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.sub_strand.label(class="form-label") }}
                {{ form.sub_strand(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.day.label(class="form-label") }}
                {{ form.day(class="form-select") }}
            </div>

            <div class="col-md-6">
                {{ form.period.label(class="form-label") }}
                {{ form.period(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.class_size.label(class="form-label") }}
                {{ form.class_size(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.performance_indicator.label(class="form-label") }}
                {{ form.performance_indicator(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.content_standard_code.label(class="form-label") }}
                {{ form.content_standard_code(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.indicator_code.label(class="form-label") }}
                {{ form.indicator_code(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.core_competencies.label(class="form-label") }}
                {{ form.core_competencies(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.keywords.label(class="form-label") }}
                {{ form.keywords(class="form-control") }}
            </div>

            <div class="col-md-6">
                {{ form.reference.label(class="form-label") }}
                {{ form.reference(class="form-control") }}
            </div>

            <!-- Rich Text Fields -->
            <div class="col-12">
                {{ form.tlr.label(class="form-label") }}
                {{ form.tlr(class="form-control richtext", rows="5") }}
            </div>

            <!-- ✅ FIXED PHASE FIELD NAMES -->
            <div class="col-12">
                {{ form.phase1_starter.label(class="form-label") }}
                {{ form.phase1_starter(class="form-control richtext", rows="5") }}
            </div>

            <div class="col-12">
                {{ form.phase2_main.label(class="form-label") }}
                {{ form.phase2_main(class="form-control richtext", rows="5") }}
            </div>

            <div class="col-12">
                {{ form.phase3_reflection.label(class="form-label") }}
                {{ form.phase3_reflection(class="form-control richtext", rows="5") }}
            </div>

        </div>

        <!-- Submit -->
        {{ form.submit(class="btn btn-primary mt-3", type="submit") }}
    </form>
</div>

<!-- TinyMCE -->
<script src="https://cdn.tiny.cloud/1/w18262pf1lnpyho91k7se0xwtplla8zqdpnkt0ttppotlkke/tinymce/6/tinymce.min.js"
        referrerpolicy="origin"></script>
<script>
    tinymce.init({
        selector: '.richtext',
        menubar: false,
        plugins: 'lists link image paste table code',
        toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | code',
        paste_data_images: true,
        height: 250
    });

    // ✅ CRITICAL: sync TinyMCE before submit
    document.getElementById('lessonForm').addEventListener('submit', function () {
        tinymce.triggerSave();
    });
</script>
{% endblock %}